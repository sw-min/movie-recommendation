<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .dotchart {
      margin-top: 0px;
    }
    .svgclass {
      border-style: solid;
      border-color: black;
      padding: 5px;
      
    }
    .content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .wrapperColumn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 40%;
    }
    .wrapperRow {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
    }
    .filter {
      padding-right: 50px;
    }

    .filterbuttons button {
      width: 5rem;
      min-height: 5rem;
      border-radius: 0.5rem;
      border: 2px solid #b5bfd9;
      background-color: #fff;
      box-shadow: 0 5px 10px rgba(lightgrey, 0.1);
      transition: 0.15s ease;
      cursor: pointer;
      position: relative
    }
    .filterbuttons button:hover, .filterbuttons button:active  {
      border-color: black;
		}

    .recTitle {
      font-family: Arial, Helvetica, sans-serif;
      font-size: xx-large;
      font-weight: 800;
    }

    .movie_rec {
      font-family: Arial, Helvetica, sans-serif;
    }

    .title {
      font-weight: 600;
      font-style: italic;
    }

    .genre {
      font-style: italic;
      color: steelblue;
    }

    .year {
      font-size: small;
    }

  </style>
  <title>INFO 3300-Project 2</title>
</head>

<body>
  <h1>INFO 3300 - Project 2</h1>
  <h3>Members: Josette, Laura, Peter, Sung Woo</h3>

  <div class="content">
    <p> Instructions: <br>Choose a genre and then click any of the following preferences to see how unique your movie taste is compared to IMDB's top rated movies! 
      <br>
      - If you add multiple preferences, add from top to bottom
      <br>
      - If you recieve a 0% and want to keep filtering, refresh the page or unclick and reclick a genre to start over
      <br>
      - Only click one box per question.
    </p>
    <div class="wrapperRow">
      <div class="wrapperColumn">
        <div class="filter"> 
          <h3> Select one genre: </h3>
          <div class="filterbuttons" id="genrebuttons"></div>
          <h3> What decade of movies do you prefer?</h3>
          <div class="filterbuttons" id="erabuttons"></div>
          <h3> How long do you want the runtime?</h3>
          <div class="filterbuttons" id="rtbuttons"></div>
          <h3> Do you prefer a specfic director?</h3>
          <div class="filterbuttons" id="directorbuttons"></div>
          <h3> Do you prefer a production company?</h3>
          <div class="filterbuttons" id="companybuttons"></div>
        </div>
      </div>
      <div class="wrapperColumn">
        <div class="dotchart">
          <h3>How unique is your movie taste?</h3>
          <svg class = "svgclass" id="svg1" height="320" width="500"></svg> 
        </div>
        <div id="recommendations"></div>
      </div>
    </div>
  </div>

    
  <script>
      // Request data
      const genrebuttons = async function () {
        console.log('running genrebuttons')
      const imdb_small = await d3.csv("imdb_100.csv");

      const data = imdb_small
      let filterTags = [];
      let dataset = [];

      // Genre filter
      const genres = ["Drama", "Crime", "Action", "Biography", "History", "Adventure", "Sci-Fi", "Fantasy", "Thriller", "Comedy", "War", "Romance", "Horror", "Family", "Western", "Film-Noir", "Music", "Musical", "Mystery", "Animation"]
      var percent='100';
      // Creating buttons for genres
      genres.forEach(function(i) {
        // console.log('in genre for each loop')

        d3.select('div#genrebuttons')
          .append("button")
          .attr("id", i)
          .text(i)
          .on("click", function() {
              if(!filterTags.includes(i)) {
                filterTags.push(i);
                filterdata = data.filter(function(d){ return d['genre'].includes(i); });
                // update(filterdata);
                //count rows in filter data
                console.log("Added " + i + "!")
                let percent = filterdata.length;
                dots(percent);
                console.log(filterTags);
                dataset = filterdata;
                updateMovieList(filterdata);

                map.select("#preferencePERCENT").remove();
                map.append("text").text(percent + "% of movies match your preferences.")
                  .attr("id", "preferencePERCENT")
                  .attr("x", 0)
                  .attr("y", 10)
                  .style("font-size", 24);
                  d3.select(`button#${i}`).style("background-color", "lightgrey");


              } else {
                filterTags.splice(filterTags.indexOf(i), 1);
                // filterdata = data.filter(function(d){ return d['genre'].includes(!filterTags); });
                map.select("#preferencePERCENT").remove();
                console.log("Removed!")
                console.log(filterdata.length);
                console.log(filterTags)
                d3.select(`button#${i}`).style("background-color", "white");

              }
          });
            //count rows in filter data
            //move that many dots to the bottom half of the svg
        // d3.select(`div#${i}`)
        //   .append("label")
        //   .attr("for", i)
        //   .text(i);


      })



      // Era filter
      const eras = ["1920s", "1930s", "1940s", "1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s", "2020s"]
      let era = [];

      eras.forEach(function(i) {
          console.log('in era for-each loop')
          d3.select("div#erabuttons")
            .append("button")
            .attr("id", i)
            .text(i)
            .on("click", function() {
                if(era.length==0) {
                  decade = i.slice(0,3)
                  console.log(decade)
                  filterdata = filterdata.filter(function(d){
                    return d['year'].includes(decade);
                  })
                  // update(filterdata);
                  console.log(filterdata);
                  //count rows in filter data
                  let percent = filterdata.length;
                  dots(percent);
                  updateMovieList(filterdata);
                  console.log(percent);
                  map.select("#preferencePERCENT").remove();
                  map.append("text").text(percent + "% of movies match your preferences.")
                    .attr("id", "preferencePERCENT")
                    .attr("x", 0)
                    .attr("y", 10);
                  d3.select(`button#${i}`).style("background-color", "lightgrey");
                } else {
                  era.splice(era.indexOf(i), 1);
                  d3.select(`button#${i}`).style("background-color", "white");
                }
                })

                //move that many dots to the bottom half of the svg
            })

        //duration filter

        const runtimes = ["60-90", "90-120", "120-150", "150-180", "180-210", "210-240"]


        //90-120 broken?
        runtimes.forEach(function(i) {
          console.log('in rt for-each loop')
          d3.select("div#rtbuttons")
            .append("button")
            .text(i)
            .on("click", function() {
                const interval = i.split('-')
                start = interval[0]
                end = interval[1]
                console.log(interval)
                console.log(start)
                console.log(end)
                filterdata = filterdata.filter(function(d){
                  return d['duration']>=start && d['duration']<=end;
                })
                // update(filterdata);
                //** 90-120 range not working??
                console.log(filterdata);
                //count rows in filter data
                let percent = filterdata.length;
                dots(percent);
                updateMovieList(filterdata);
                console.log(percent);
                map.select("#preferencePERCENT").remove();
                  map.append("text").text(percent + "% of movies match your preferences.")
                    .attr("id", "preferencePERCENT")
                    .attr("x", 0)
                    .attr("y", 10);
                })
                //move that many dots to the bottom half of the svg
            })

        

        //repeat for next filter and feed in already-filtered filterdata array to layer the filters
        //count new number of dots each time and only have that amount display on the bottom
      
        //director filter 
        const directors = ['Alfred Hitchcock', 'Quentin Tarantino', 'Steven Spielberg', 'Christopher Nolan', 'David Fincher']
        const direct = [];

         directors.forEach(function(i) {
          console.log('in director for-each loop')
          d3.select("div#directorbuttons")
            .append("button")
            .attr("id", i.replace(" ", ""))
            .text(i)
            .on("click", function() {
                if(direct.length === 0) {
                direct.push(i.replace(" ", ""));
                console.log(i);
                filterdata = filterdata.filter(function(d){
                  return d['director'].includes(i);
                })
                // update(filterdata);
                //count rows in filter data
                console.log(filterdata);
                let percent = filterdata.length;
                dots(percent);
                updateMovieList(filterdata);
                console.log(percent);
                map.select("#preferencePERCENT").remove();
                  map.append("text").text(percent + "% of movies match your preferences.")
                    .attr("id", "preferencePERCENT")
                    .attr("x", 0)
                    .attr("y", 10);
                d3.select(`button#${i.replace(" ", "")}`).style("background-color", "lightgrey");
              } else {
                direct.splice(direct.indexOf(i.replace(" ", "")), 1);
                d3.select(`button#${i.replace(" ", "")}`).style("background-color", "white");
              }
            })
                //move that many dots to the bottom half of the svg
            })

          //company filter
          const production_companies = ['Paramount Pictures', 'Universal Pictures', 'Warner Bros.', 'Castle Rock Entertainment']

          let prod = [];

          production_companies.forEach(function(i) {
          console.log('in company for-each loop')
          d3.select("div#companybuttons")
            .append("button")
            .attr("id", i.replace(" ", "").replace(" ", "").replace(".", ""))
            .text(i)
            .on("click", function() {
                if( prod.length == 0 ) {
                prod.push(i.replace(" ", "").replace(" ", "").replace(".", ""));
                console.log(i);
                filterdata = filterdata.filter(function(d){
                  return d['production_company'].includes(i);
                })
                console.log(prod)
                // update(filterdata);
                //count rows in filter data
                console.log(filterdata);
                let percent = filterdata.length;
                dots(percent);
                updateMovieList(filterdata);
                console.log(percent);
                map.select("#preferencePERCENT").remove();
                map.append("text").text(percent + "% of movies match your preferences.")
                  .attr("id", "preferencePERCENT")
                  .attr("x", 0)
                  .attr("y", 10);
                d3.select(`button#${i.replace(" ", "").replace(" ", "").replace(".", "")}`).style("background-color", "lightgrey");
                } else {
                  prod.splice(prod.indexOf(i.replace(" ", "").replace(" ", "").replace(".", "")), 1);
                  d3.select(`button#${i.replace(" ", "").replace(" ", "").replace(".", "")}`).style("background-color", "white");
                }
              })
                //move that many dots to the bottom half of the svg
            })
      
  
     

      
     
      
//DOT CHART CODE BELOW:

      const svg = d3.select("#svg1");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = {top: 10, right: 10, bottom: 10, left: 10};
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // const projectData = async function () {
       console.log('in async')

      //Movie names on the top 100 are 'original_title', top 1000 are 'Series_Title', and RT are 'Name'
      // const imdb_small = await d3.csv("imdb_100.csv");
      const imdb_large = await d3.csv("imdb_1000.csv");
      console.log(imdb_large)
      const rotten_tomatoes = await d3.csv("rotten_tomatoes.csv");

      console.log(imdb_small);
      // console.log(genre);
  

//DYNAMIC DOT CHART
var pointseparation = 10; //space between dots
var pointsPerRow = 20; //points per row

function positionOfCircle(isBottom, index) {
  xPos = 20; //initial x position
  yPos = 40; //initial y position

  color = 'blue';

  console.log(isBottom);
  if (isBottom === true) {
    yPos += 200;
    color = 'red';
  }

  xPos += (index % pointsPerRow) * pointseparation;
  // console.log(pointseparation);
  // console.log(xPos);
  yPos += Math.floor(index/pointsPerRow) * pointseparation;
  // console.log(yPos);

  

  return {x:xPos, y:yPos, fill:color};

}

function dots(percent){
console.log('running dots')
//set score text at bottom (not working currently)
  var feedbacktext = 'loading';
  if (percent > 50) {
    feedbacktext = 'Your taste is kinda basic..';
    console.log('in if')
  }
  if (30 < percent < 50 ) {
    feedbacktext = 'Your preferences are.. slightly unique'
  }
  if (20 < percent < 30) {
    feedbacktext = 'You have unique taste'
 }
  if (0 < percent < 20) {
    feedbacktext = 'Your preferences are very unique!'
 }
  if (percent === 0)  {
    feedbacktext = "Your taste is so unique, we couldn't find any movies that match!"
 }
 results = feedbacktext;
 map.append('text').text('Results: ' + results).attr("x", 0).attr("y", 300);
percentTop= percent;
//100 movies so can use percent as number of dots
console.log(percentTop);
map.selectAll("circle").data(imdb_small, (d,i)=>i)
    .join("circle")
    .attr("class", "dots")
    .attr("r", 5)
    .attr("cx", (d,i)=> {
      let index = i;
      let isBottom = false;
      if (i > (percentTop-1)) {
        index = index - percentTop;
        isBottom = true;
      }
      return pos = positionOfCircle(isBottom, index).x
    })
    .attr("cy", (d,i)=> {
      let index = i;
      let isBottom = false;
      if (i> (percentTop-1)) {
        index = index - percentTop;
        isBottom = true;
      }
      return pos = positionOfCircle(isBottom, index).y
    })
    .attr("fill", (d,i)=> {
      let index = i;
      let isBottom = false;
      if (i > (percentTop-1)) {
        index = index - percentTop;
        isBottom = true;
      }
      return pos = positionOfCircle(isBottom, index).fill
    })
}



  // Add poster links from IMDb 1000 to 100
  imdb_small.forEach((movie) => {
    let movieTitle = imdb_large.find((d) => d["Series_Title"] === movie["original_title"]);
    let poster = "";
    if (movieTitle) {
      poster = movieTitle["Poster_Link"];
    }
    movie["poster"] = poster;
  })


  
  
  // Initial percentage text
  map.append("text").text("Press on some tags to see what percent of movies match!")
                  .attr("id", "preferencePERCENT")
                  .attr("x", 0)
                  .attr("y", 10);;

  // Handmade legend
  // map.append("circle").attr("cx",200).attr("cy",130).attr("r", 2)
  // map.append("circle").attr("cx",200).attr("cy",160).attr("r", 2).style("fill", "#FF0000")
  map.append("text").attr("x", 220).attr("y", 130).text("Movies that match preferences").style("font-size", "15px").attr("alignment-baseline","middle").style('fill', 'blue')
  // map.append("line").attr("x1", 0).attr("x2", 500).attr("y1", 145).attr("y2", 145)
  map.append("text").attr("x", 220).attr("y", 160).text("Movies that don't").style("font-size", "15px").attr("alignment-baseline","middle").style('fill', 'red')

  // MOVIE RECOMMENDATIONS SECTION
  const recCanvasHeight = 400;
  const recCanvasWidth = 500;
  const margins = {top: 10, right: 10, bottom: 50, left: 50};
  const recChartWidth = recCanvasWidth - margins.left - margins.right;
  const recChartHeight = recCanvasHeight - margins.top - margins.bottom;

  let recSVG = d3.select("div#recommendations").append("svg")
                  .attr("id", "movieRecSVG")
                  .attr("height", recCanvasHeight)
                  .attr("width", recCanvasWidth);

  const canvas = d3.select("svg#svg");

function updateMovieList (filteredMovies) {
  
  movieFilterList = filteredMovies.map((x) => x);
  let movieList = [];
  movieFilterList.forEach( movie => {
    let dict = {};
    dict["Title"] = movie["original_title"];
    dict["Year"] = movie["year"];
    dict["Genre"] = movie["genre"];
    dict["Runtime"] = movie["duration"];

    try{
    dict["poster"] = movie["poster"];
    }
    catch(err) {
      dict["poster"] = null;
    }
    movieList.push(dict);
  });

  updateMovieRecs(movieList);

}

  //Get top 3 movies
  const yScale = d3.scaleLinear().domain( [0, 3] )
                                 .range( [recChartHeight, 0] );

  recSVG.append("text")
        .attr("x", margins.top)
        .attr("y", margins.bottom)
        .text("Movie Recommendations")
        .attr("class", "recTitle");

  function updateMovieRecs (movieRecsArray) {
  d3.selectAll("svg#movieRecSVG > .movie_rec").remove();

  let movieRecs = movieRecsArray.slice(0, 3);
  console.log(movieRecs)
  
  movieRecs.forEach( (movie, i) => {
      let titleLength = Number(movie["Title"].length);

      //Title
      recSVG.append("text")
          .attr("x", margins.left + 100)
          .attr("y",  yScale(i) - 20)
          .text(movie["Title"])
          .attr("class", "title movie_rec");
      
      //Year
      recSVG.append("text")
        .attr("x", margins.left + 100)
        .attr("y",  yScale(i))
        .text( "(" + movie["Year"] + ")")
        .attr("class", "year movie_rec");

      // Genre
      recSVG.append("text")
        .attr("x", margins.left + 145)
        .attr("y",  yScale(i))
        .text(movie["Genre"])
        .attr("class", "genre movie_rec");
      
         // Runtime
         recSVG.append("text")
        .attr("x", margins.left + 100)
        .attr("y",  yScale(i) + 20)
        .text("Runtime: "+ movie["Runtime"] + " minutes") //Add percentage match!
        .attr("class", "permatch movie_rec");

      /* // Rating
      recSVG.append("text")
        .attr("x", recChartWidth - margins.left)
        .attr("y",  yScale(i) - 20)
        .text("Rating: " + movie["Rating"])
        .attr("class", "ratings movie_rec"); */
          
      if (movie["poster"] != null) {    
        recSVG.append("image")
        .attr("href", movie["poster"])
        .attr("x", margins.left)
        .attr("y", yScale(i) - 70)
        .attr("width", 75)
        .attr("height", 150)
        .attr("class", "movie_rec");}
      
      else {
        recSVG.append("image")
        .attr("href", "./static/not_found.jpeg")
        .attr("x", margins.left)
        .attr("y", yScale(i) - 70)
        .attr("width", 75)
        .attr("height", 150)
        .attr("class", "movie_rec"); };
    });
   
   
  }}
  genrebuttons();

//     }

// projectData();

   

  
    </script>
</div>




</body>
</html>
